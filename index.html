<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Himalaya Fly</title>
<style>
  body{
    margin:0;
    font-family: "Trebuchet MS", Arial, sans-serif;
    background: linear-gradient(to bottom,#1e3c72,#2a5298);
    color: #fff;
    text-align:center;
    -webkit-font-smoothing:antialiased;
  }
  header{background:#0d1b2a;padding:16px;}
  header h1{margin:0;font-size:26px}
  #gameArea{max-width:560px;margin:28px auto;padding:18px;background:rgba(255,255,255,0.06);border-radius:12px;}
  button{background:#0077b6;border:none;color:#fff;padding:12px 20px;border-radius:8px;font-size:16px;cursor:pointer;margin:8px}
  button:hover{background:#00b4d8}
  #heightDisplay{font-size:26px;margin-top:18px;font-weight:700}
  #leaderboard{max-width:520px;margin:20px auto;padding:16px;border-radius:10px;background:rgba(255,255,255,0.08)}
  #leaderboard h2{margin:0 0 12px 0}
  ul{list-style:none;padding:0;margin:0}
  li{background:rgba(255,255,255,0.1);padding:8px;border-radius:6px;margin:6px 0;color:#fff}
  /* debug box */
  #debug{position:fixed;left:10px;bottom:10px;max-width:320px;max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.45);font-size:12px;color:#fff;text-align:left;z-index:9999}
  .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:5000}
  .modal .box{background:#fff;color:#000;padding:18px;border-radius:8px;max-width:420px;margin:0 12px}
  input[type="text"]{width:90%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ccc}
  @media (max-width:420px){header h1{font-size:20px} #heightDisplay{font-size:20px}}
</style>
</head>
<body>
  <header><h1>üèî Himalaya Fly</h1></header>

  <div id="gameArea">
    <p><strong>After pressing Start, measurement begins after a 3s countdown.</strong></p>
    <button id="startBtn">Start Throw</button>
    <div id="heightDisplay">Height: 0.00 m</div>
  </div>

  <div id="leaderboard">
    <h2>üèÜ Leaderboard (Top 10)</h2>
    <ul id="leaderboardList"></ul>
  </div>

  <!-- final modal -->
  <div id="finalModal" class="modal">
    <div class="box">
      <p id="finalMessage">Your final score: 0.00 m</p>
      <input id="playerName" type="text" placeholder="Enter your name (optional)" />
      <div style="margin-top:12px;text-align:center">
        <button id="submitBtn">Submit Score</button>
        <button id="retryBtn">Try Again</button>
      </div>
    </div>
  </div>

  <!-- debug area -->
  <pre id="debug" aria-hidden="true"></pre>

  <!-- Firebase SDK (v8 compatible) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ======================
   CONFIG: Replace these with your Firebase project's actual values
   You can find them in Firebase console -> Project settings -> SDK setup and config
   ====================== */
const firebaseConfig = {
    apiKey: "AIzaSyBmjXmGD9jzBIWJxm2TPp9oaQRVN_v7TtU",
    authDomain: "himalayafly.firebaseapp.com",
    databaseURL: "https://himalayafly-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "himalayafly",
    storageBucket: "himalayafly.firebasestorage.app",
    messagingSenderId: "342193900033",
    appId: "1:342193900033:web:1d2d0a5cf158e4075c8e00",
    measurementId: "G-T58K1DT564"
};
/* ====================== */

function dbg(msg){
  console.log(msg);
  const d = document.getElementById('debug');
  if(!d) return;
  const time = new Date().toLocaleTimeString();
  d.textContent = `${time} ‚Äî ${msg}\n` + d.textContent;
}
try{
  firebase.initializeApp(firebaseConfig);
  dbg('Firebase initialized');
}catch(e){
  dbg('Firebase init error: ' + (e && e.message));
}

const db = firebase.database();

/* ---------- GAME LOGIC ---------- */
let measuring = false;
let peakNetAcc = 0;      // peak net accel (m/s^2)
let measureTimeout = null;
let animationInterval = null;

const startBtn = document.getElementById('startBtn');
const heightDisplay = document.getElementById('heightDisplay');
const finalModal = document.getElementById('finalModal');
const finalMessage = document.getElementById('finalMessage');
const submitBtn = document.getElementById('submitBtn');
const retryBtn = document.getElementById('retryBtn');

startBtn.addEventListener('click', startCountdown);
submitBtn.addEventListener('click', submitScore);
retryBtn.addEventListener('click', ()=> { finalModal.style.display='none'; });

async function startCountdown(){
  if(measuring) return;
  peakNetAcc = 0;
  heightDisplay.textContent = 'Get ready! Measuring starts in 3...';
  let count = 3;
  const ci = setInterval(()=>{
    count--;
    if(count>0){
      heightDisplay.textContent = 'Get ready! Measuring starts in ' + count + '...';
    } else {
      clearInterval(ci);
      startMeasurement();
    }
  },1000);
}

async function startMeasurement(){
  // request device motion permission on iOS Safari
  try {
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
      const p = await DeviceMotionEvent.requestPermission();
      dbg('DeviceMotionEvent.requestPermission -> ' + p);
      if(p !== 'granted'){
        alert('Motion permission denied. Cannot measure throw.');
        return;
      }
    }
  } catch (err){
    dbg('DeviceMotion permission error: ' + (err && err.message));
    // continue ‚Äî many browsers don't require requestPermission
  }

  // Reset
  peakNetAcc = 0;
  measuring = true;
  heightDisplay.textContent = 'Measuring throw...';
  window.addEventListener('devicemotion', motionHandler, {passive:true});

  // stop after 3s
  measureTimeout = setTimeout(() => {
    stopMeasurement();
  }, 3000);
}

function motionHandler(ev){
  if(!measuring) return;
  const acc = ev.accelerationIncludingGravity;
  if(!acc) return;

  // compute magnitude
  const ax = acc.x || 0;
  const ay = acc.y || 0;
  const az = acc.z || 0;
  const total = Math.sqrt(ax*ax + ay*ay + az*az);

  // net acceleration (subtract gravity). Keep positive only
  const gravity = 9.80665;
  let net = total - gravity;
  if(net < 0) net = 0;

  // ignore very small noise
  if(net < 0.3) net = 0;

  if(net > peakNetAcc) peakNetAcc = net;

  // show a live scaled preview (use small scale so it looks reasonable)
  const preview = round2(peakNetAcc * 0.5); // preview scale
  heightDisplay.textContent = `Height: ${preview.toFixed(2)} m`;
}

function stopMeasurement(){
  if(!measuring) return;
  measuring = false;
  window.removeEventListener('devicemotion', motionHandler);
  if(measureTimeout) { clearTimeout(measureTimeout); measureTimeout = null; }

  // convert peakNetAcc to a user-visible "height" score
  // scaleFactor chosen so typical hand moves give small friendly numbers
  const scaleFactor = 0.5; // tune as needed
  const score = Math.max(0, round2(peakNetAcc * scaleFactor));

  // animate count-up
  let current = 0;
  const target = Math.round(score); // integer display for fun
  clearInterval(animationInterval);
  animationInterval = setInterval(()=>{
    if(current >= target){
      clearInterval(animationInterval);
      heightDisplay.textContent = `Final Height: ${score.toFixed(2)} m`;
      showFinal(score);
    } else {
      current++;
      heightDisplay.textContent = `Height: ${current} m`;
    }
  }, 12);
}

function showFinal(score){
  finalMessage.textContent = `Your final score: ${score.toFixed(2)} m`;
  finalModal.style.display = 'flex';
}

function closeFinal(){
  finalModal.style.display = 'none';
}

function round2(v){ return Math.round(v*100)/100; }

/* ---------- SUBMIT & FIREBASE ---------- */

async function submitScore(){
  const name = (document.getElementById('playerName').value || 'Anonymous').trim();
  const matches = finalMessage.textContent.match(/([\d\.]+)/);
  const score = matches ? parseFloat(matches[0]) : 0;
  let country = 'Unknown';

  try {
    dbg('Fetching region via ipapi...');
    const res = await fetch('https://ipapi.co/json/');
    if(res.ok){
      const json = await res.json();
      country = json.country_name || 'Unknown';
      dbg('Region detected: ' + country);
    } else {
      dbg('ipapi response not ok: ' + res.status);
    }
  } catch(err){
    dbg('Region fetch failed: ' + (err && err.message));
  }

  try {
    await saveScore(name, score, country);
    closeFinal();
    dbg(`Saved: ${name} ‚Ä¢ ${score} ‚Ä¢ ${country}`);
    // the realtime listener will update leaderboard automatically
  } catch(err){
    dbg('Save failed: ' + (err && err.message));
    alert('Failed to save score: ' + (err && err.message));
  }
}

async function saveScore(name, score, region){
  // push the new score, then prune DB to top 10
  const ref = db.ref('scores').push();
  await ref.set({ name, score, region, timestamp: Date.now() });

  // prune (keep only top 10)
  const snap = await db.ref('scores').orderByChild('score').once('value');
  const arr = [];
  snap.forEach(s => arr.push({ key: s.key, ...s.val() }));

  // sort descending by score
  arr.sort((a,b)=> (b.score||0) - (a.score||0));

  const toRemove = arr.slice(10); // beyond top 10
  for(const item of toRemove){
    try{
      await db.ref('scores/' + item.key).remove();
      dbg('Pruned old entry: ' + item.key);
    } catch(e){
      dbg('Prune remove failed: ' + e.message);
    }
  }
}

/* ---------- LEADERBOARD (realtime) ---------- */

function fetchLeaderboard() {
    db.ref("scores")
      .orderByChild("score")
      .limitToLast(10)
      .on("value", snapshot => {
          const scoresArray = [];

          snapshot.forEach(childSnap => {
              scoresArray.push(childSnap.val());
          });

          // Sort descending (highest first)
          scoresArray.sort((a, b) => b.score - a.score);

          const list = document.getElementById("leaderboardList");
          list.innerHTML = "";

          // Display top 10 scores
          scoresArray.forEach((s, i) => {
              const li = document.createElement("li");
              li.innerHTML = `<strong>#${i + 1}</strong> ${s.name || "Anonymous"} ‚Äî ${s.score} m <br><small>${s.region || "Unknown"}</small>`;
              list.appendChild(li);
          });
      });
}


/* initialize */
fetchLeaderboard();
dbg('Leaderboard listener attached.');

/* ---------- Helpful note for Firebase rules (index on score) ---------- */
/*
 To remove the client-side warning about "Using an unspecified index" (and improve performance),
 open Firebase console > Realtime Database > Rules and add ".indexOn": ["score"] under the "scores" node.

 Example rules for testing (public, not secure ‚Äî use for development only):
 {
   "rules": {
     "scores": {
       ".read": true,
       ".write": true,
       ".indexOn": ["score"]
     }
   }
 }

 After testing, change rules to require authentication / secure writes.
*/

</script>
</body>
</html>
