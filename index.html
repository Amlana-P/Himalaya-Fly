<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Himalaya Fly Game</title>
<style>
    body {
        margin: 0;
        font-family: 'Trebuchet MS', Arial, sans-serif;
        background: linear-gradient(to bottom, #1e3c72, #2a5298);
        text-align: center;
        color: white;
        overflow-x: hidden;
    }
    header {
        background: #0d1b2a;
        color: white;
        padding: 15px;
        text-align: center;
    }
    header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: bold;
    }
    #gameArea {
        margin: 40px auto;
        max-width: 500px;
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
    }
    button {
        background: #0077b6;
        border: none;
        color: white;
        padding: 12px 20px;
        margin: 10px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
    }
    button:hover { background: #00b4d8; }
    #heightDisplay {
        font-size: 28px;
        margin: 20px;
        font-weight: bold;
    }
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.6);
        text-align: center;
    }
    .modal-content {
        background: #fff;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 400px;
        color: black;
    }
    .modal button { margin-top: 15px; }
    #leaderboard {
        margin: 30px auto;
        max-width: 400px;
        padding: 15px;
        background: rgba(255,255,255,0.15);
        border-radius: 12px;
    }
    #leaderboard h2 { margin-top: 0; }
    #leaderboardList {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #leaderboardList li {
        background: rgba(255,255,255,0.1);
        margin: 5px 0;
        padding: 8px;
        border-radius: 6px;
    }
</style>
</head>
<body>
<header>
    <h1>üèî Himalaya Fly Game</h1>
</header>

<div id="gameArea">
    <p><strong>After pressing Start, throw will begin in 3 seconds!</strong></p>
    <button onclick="startCountdown()">Start Throw</button>
    <div id="heightDisplay">Height: 0 m</div>
</div>

<!-- Final Score Modal -->
<div id="finalModal" class="modal">
    <div class="modal-content">
        <p id="finalMessage"></p>
        <input type="text" id="playerName" placeholder="Enter your name">
        <br>
        <button onclick="submitScore()">Submit Score</button>
        <button onclick="closeModal()">Try Again</button>
    </div>
</div>

<!-- Leaderboard -->
<div id="leaderboard">
    <h2>üèÜ Leaderboard</h2>
    <ul id="leaderboardList"></ul>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
/* üî• Replace with your Firebase config */
const firebaseConfig = {
    apiKey: "AIzaSyBmjXmGD9jzBIWJxm2TPp9oaQRVN_v7TtU",
    authDomain: "himalayafly.firebaseapp.com",
    databaseURL: "https://himalayafly-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "himalayafly",
    storageBucket: "himalayafly.firebasestorage.app",
    messagingSenderId: "342193900033",
    appId: "1:342193900033:web:1d2d0a5cf158e4075c8e00",
    measurementId: "G-T58K1DT564"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Game Vars */
let throwing = false, maxHeight = 0, lastY = null, velocity = 0, animationInterval;

/* Countdown before throw starts */
function startCountdown() {
    let display = document.getElementById("heightDisplay");
    let countdown = 3;
    display.innerText = "Get ready! Throw starts in " + countdown + " sec...";
    let timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            display.innerText = "Get ready! Throw starts in " + countdown + " sec...";
        } else {
            clearInterval(timer);
            startListening();
        }
    }, 1000);
}

function handleMotion(event) {
    if (!throwing) return;
    let y = event.accelerationIncludingGravity.y || 0;
    if (lastY !== null) {
        velocity += (y - lastY) * 0.1;
        maxHeight += velocity * 0.05;
        if (maxHeight < 0) maxHeight = 0;
        document.getElementById("heightDisplay").innerText = "Height: " + Math.round(maxHeight) + " m";
    }
    lastY = y;
}

function startListening() {
    throwing = true;
    maxHeight = 0; lastY = null; velocity = 0;
    document.getElementById("heightDisplay").innerText = "Height: 0 m";
    window.addEventListener("devicemotion", handleMotion);

    setTimeout(stopThrow, 3000); // auto stop after 3 sec
}

function stopThrow() {
    if (!throwing) return;
    throwing = false;
    window.removeEventListener("devicemotion", handleMotion);
    let score = Math.max(0, Math.round(maxHeight * 2));

    // Animate score count up
    let current = 0;
    clearInterval(animationInterval);
    animationInterval = setInterval(() => {
        if (current >= score) {
            clearInterval(animationInterval);
            showFinalModal(score);
        } else {
            current++;
            document.getElementById("heightDisplay").innerText = `Height: ${current} m`;
        }
    }, 15);
}

function showFinalModal(score) {
    document.getElementById("finalMessage").innerText = "Your final score: " + score + " m";
    document.getElementById("finalModal").style.display = "block";
}

function closeModal() {
    document.getElementById("finalModal").style.display = "none";
}

function submitScore() {
    let name = document.getElementById("playerName").value || "Anonymous";
    let score = parseInt(document.getElementById("finalMessage").innerText.match(/\d+/)[0]);

    // Try to fetch user region
    let region = "Unknown";
    fetch("https://ipapi.co/json/")
        .then(res => res.json())
        .then(data => {
            region = data.country_name || "Unknown";
        })
        .finally(() => {
            saveScore(name, score, region);
            closeModal();
        });
}

function saveScore(name, score, region) {
    db.ref("scores").push({ 
        name: name, 
        score: score, 
        region: region, 
        timestamp: Date.now() 
    }).then(() => {
        console.log("‚úÖ Score saved:", name, score, region);
        fetchLeaderboard();
    }).catch(err => {
        console.error("‚ùå Error saving score:", err);
        alert("Error saving score: " + err.message);
    });
}

function fetchLeaderboard() {
    db.ref("scores").orderByChild("score").limitToLast(10).on("value", snapshot => {
        let scoresArray = [];
        snapshot.forEach(snap => scoresArray.push(snap.val()));

        scoresArray.sort((a, b) => b.score - a.score);

        let list = document.getElementById("leaderboardList");
        list.innerHTML = "";
        scoresArray.forEach(s => {
            let li = document.createElement("li");
            li.innerText = `${s.name || "Anonymous"} - ${s.score} m (${s.region || "Unknown"})`;
            list.appendChild(li);
        });
    });
}
fetchLeaderboard();
</script>
</body>
</html>
